version: '3.8'

# Define custom network for service communication
networks:
  hotel-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.28.0.0/16}

# Define named volumes for data persistence
volumes:
  postgres-data:
    driver: local
  backend-logs:
    driver: local

services:
  # =============================================================================
  # PostgreSQL Database Service
  # =============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: hotel-postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: ${POSTGRES_USER:-hotel_admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-hotel_management}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      # Performance tuning
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-100}
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}

    volumes:
      # Data persistence
      - postgres-data:/var/lib/postgresql/data
      # Database initialization scripts (run on first start only)
      - ./hotel-app-be/database/00_create_user.sql:/docker-entrypoint-initdb.d/00_create_user.sql:ro
      - ./hotel-app-be/database/00_init.sql:/docker-entrypoint-initdb.d/00_init.sql:ro
      - ./hotel-app-be/database/migrations:/docker-entrypoint-initdb.d/migrations:ro
      - ./hotel-app-be/database/seed-data:/docker-entrypoint-initdb.d/seed-data:ro
      # Custom PostgreSQL configuration (if exists)
      # - ./deployment/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    networks:
      - hotel-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-hotel_admin} -d ${POSTGRES_DB:-hotel_management}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: "${POSTGRES_CPU_LIMIT:-1.0}"
          memory: ${POSTGRES_MEMORY_LIMIT:-512M}
        reservations:
          cpus: "0.25"
          memory: 128M

  # =============================================================================
  # Backend API Service (Rust/Axum)
  # =============================================================================
  backend:
    build:
      context: ./hotel-app-be
      dockerfile: Dockerfile
      args:
        # Build-time arguments (if needed)
        RUST_VERSION: "latest"

    image: hotel-backend:${BACKEND_VERSION:-latest}
    container_name: hotel-backend
    restart: unless-stopped

    environment:
      # Database connection
      DATABASE_URL: postgresql://${POSTGRES_USER:-hotel_admin}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-hotel_management}
      DATABASE_MAX_CONNECTIONS: ${DATABASE_MAX_CONNECTIONS:-10}

      # JWT configuration
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-3600}
      REFRESH_TOKEN_EXPIRATION: ${REFRESH_TOKEN_EXPIRATION:-604800}

      # Server configuration
      BACKEND_HOST: ${BACKEND_HOST:-0.0.0.0}
      BACKEND_PORT: ${BACKEND_PORT:-3030}

      # CORS settings
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:80}

      # Logging
      RUST_LOG: ${RUST_LOG:-info}
      RUST_BACKTRACE: ${RUST_BACKTRACE:-0}

      # Environment
      ENVIRONMENT: ${ENVIRONMENT:-production}

    volumes:
      # Log persistence
      - backend-logs:/app/logs

    ports:
      - "${BACKEND_PORT:-3030}:3030"

    networks:
      - hotel-network

    depends_on:
      postgres:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: "${BACKEND_CPU_LIMIT:-1.0}"
          memory: ${BACKEND_MEMORY_LIMIT:-512M}
        reservations:
          cpus: "0.25"
          memory: 128M
      replicas: ${BACKEND_REPLICAS:-1}

  # =============================================================================
  # Frontend Web Service (React/Nginx)
  # =============================================================================
  frontend:
    build:
      context: ./hotel-web-fe
      dockerfile: Dockerfile
      args:
        # Build-time environment variables for React
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:3030}
        REACT_APP_WS_URL: ${REACT_APP_WS_URL:-ws://localhost:3030}
        REACT_APP_ENVIRONMENT: ${ENVIRONMENT:-production}
        NODE_VERSION: ${NODE_VERSION:-18}

    image: hotel-frontend:${FRONTEND_VERSION:-latest}
    container_name: hotel-frontend
    restart: unless-stopped

    ports:
      - "${FRONTEND_PORT:-3000}:80"

    networks:
      - hotel-network

    depends_on:
      backend:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

  # =============================================================================
  # Database Migration Runner (Optional separate service)
  # =============================================================================
  db-migrator:
    image: postgres:15-alpine
    container_name: hotel-db-migrator

    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-hotel_admin}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: ${POSTGRES_DB:-hotel_management}

    volumes:
      - ./database/migrations:/migrations:ro
      - ./deployment/scripts/run-migrations.sh:/run-migrations.sh:ro

    networks:
      - hotel-network

    depends_on:
      postgres:
        condition: service_healthy

    # This service runs migrations and exits
    command: ["/bin/sh", "/run-migrations.sh"]

    profiles:
      - migration  # Only run when explicitly specified
