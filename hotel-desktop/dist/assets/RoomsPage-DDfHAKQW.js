import{l as Ke,j as e,h as Qt,r,H as y,B as l,T as n,A as Q,n as c,C as Oe,o as p,p as ft,D as yt,M as Ft,q as Te,P as Tt,I as _s,t as ae,f as Dt,L as Ss,R as Cs,v as ks,w as ws}from"./index-DnWmqzJF.js";import{v as zt}from"./validation-C2QFlzQX.js";import{u as Yt}from"./useCurrency-C4JSCWBJ.js";import{g as Ve}from"./currency-SgYezy9c.js";import{D as Pe,a as Re,b as Be,c as Ae}from"./DialogTitle-DKxRfOzX.js";import{B as vt}from"./EventAvailable-CtePsli0.js";import{A as Is}from"./Autocomplete-CZ6UKh6h.js";import{P as Ws}from"./PersonAdd-C6oEVzXr.js";import{G as a}from"./Grid-0tqG7FTE.js";import{F as jt}from"./FormControlLabel-Ddfix5uo.js";import{C as Xt}from"./Checkbox-1RYp8RQ2.js";import{S as Gt}from"./Snackbar-BmHWVIFe.js";import{T as Mt}from"./AccessTime-l9--GsKj.js";import{C as pt,B as Nt,a as $t,D as Pt,M as Ht}from"./Report-B_BU71sw.js";import{C as M,a as pe}from"./CardContent-BhQI87uj.js";import{C as Ut}from"./CheckCircle-B5gS3fbx.js";import{T as Ts,a as Ds,b as Ps,c as qt,d as C,e as Rs}from"./TableRow-B78mTfEk.js";import{C as De}from"./Chip-CSuofl6d.js";import{I as Rt,L as Bs}from"./Info-DGREqatQ.js";import{E as As}from"./Edit-v4qS8plG.js";import{C as Bt}from"./Cancel-zFl1_j2m.js";import{S as At}from"./Save-B20zNACZ.js";import{S as Vt}from"./Switch-CZyKJHRo.js";import{S as Kt}from"./Search-CErNxQ4Y.js";import{C as Os}from"./Close-93h3i8eI.js";import{L as Ls}from"./ListItem-z0t0rr4D.js";import{M as Es}from"./Star-BduLiDpP.js";import"./listItemButtonClasses-Cwcgs-VK.js";const Fs=Ke(e.jsx("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorder"),zs=Ke(e.jsx("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarHalf"),Gs=Ke(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m4 14H8V8h8z"}),"StopCircle"),Ms=Ke(e.jsx("path",{d:"M1 21h4V9H1zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73z"}),"ThumbUp"),Ns=Ke(e.jsx("path",{d:"m23 12-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69zm-12.91 4.72-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48z"}),"Verified"),$s=({open:N,onClose:je,room:h,onBookingSuccess:Qe,defaultCheckInTime:re="15:00",defaultCheckOutTime:ie="11:00",guestMode:R=!1})=>{const{user:j}=Qt(),{symbol:F,format:L}=Yt(),[$,Ye]=r.useState([]),[Le,Ee]=r.useState(null),[Xe,Fe]=r.useState(!1),[H,le]=r.useState(!1),[oe,Y]=r.useState(null),[X,f]=r.useState(""),[J,fe]=r.useState(""),[ce,Z]=r.useState(""),[_,E]=r.useState(""),[Je,ye]=r.useState(""),[Ze,et]=r.useState(""),[k,B]=r.useState(""),[de,D]=r.useState(re),[I,ze]=r.useState(""),[ee,W]=r.useState(ie),[ve,z]=r.useState(""),[tt,be]=r.useState("normal_stay"),[st,ue]=r.useState("RACK"),[_e,xe]=r.useState("Cash"),[U,v]=r.useState("unpaid"),[he,S]=r.useState(0),[q,Se]=r.useState(50),[V,Ce]=r.useState(!1),[te,ke]=r.useState(0),[nt,me]=r.useState(0),[ge,Ge]=r.useState(0),[se,at]=r.useState(0),[we,rt]=r.useState(!1),[Me,T]=r.useState(null),it=["Cash","Agoda","Booking.com","Expedia","Traveloka","Visa Card","Debit Card","Master Card","Extra Bed","Tourism Tax","City Ledger (Company Master)","Qrpay","Bank Transfer","Sarawak Pay","Boost"];r.useEffect(()=>{if(N){R?j&&j.id&&Y(typeof j.id=="string"?parseInt(j.id,10):j.id):bt();const i=new Date().toISOString().split("T")[0],u=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];B(i),ze(u),D(re),W(ie);const b=Ve();Se(b.room_card_deposit)}else _t()},[N,re,ie,R,j]),r.useEffect(()=>{if(V&&k&&I){const i=Ve(),u=A();ke(u*i.tourism_tax_rate)}else ke(0)},[V,k,I]);const bt=async()=>{try{Fe(!0);const i=await y.getAllGuests();Ye(i)}catch(i){console.error("Failed to load guests:",i)}finally{Fe(!1)}},_t=()=>{Ee(null),le(!1),f(""),fe(""),Z(""),E(""),B(""),D(re),ze(""),W(ie),z(""),be("normal_stay"),ue("RACK"),xe("Cash"),v("unpaid"),S(0),Ce(!1),ke(0),me(0),Ge(0),at(0),T(null)},lt=i=>{if(i&&!$.find(u=>u.full_name.toLowerCase().includes(i.toLowerCase()))){const u=i.trim().split(" ");u.length>0&&(f(u[0]),fe(u.slice(1).join(" ")))}},d=async()=>{if(!X||!ce)return T("First name and email are required for new guest"),null;const i=zt(ce);if(i)return ye(i),T(i),null;try{const u=await y.createGuest({first_name:X,last_name:J,email:ce,phone:_||void 0});return Ye([...$,u]),Ee(u),le(!1),u}catch(u){return T(u.message||"Failed to create guest"),null}},ot=async()=>{if(!h)return;let i=null;if(R){if(!oe){T("User ID not found. Please log in again.");return}i=oe}else{let P=Le;if(H&&(P=await d(),!P))return;if(!P){T("Please select or create a guest");return}i=P.id}if(!k||!I){T("Please select check-in and check-out dates");return}const u=new Date(k),b=new Date(I);if(u.setHours(0,0,0,0),b.setHours(0,0,0,0),b<=u){T("Check-out date must be after check-in date. Please select a check-out date that is at least 1 day after check-in.");return}try{rt(!0),T(null);const P=`${k}T${de}:00`,K=`${I}T${ee}:00`;await y.createBooking({guest_id:i,room_id:String(h.id),check_in_date:P,check_out_date:K,post_type:tt,rate_code:st,booking_remarks:ve||void 0,is_tourist:V,tourism_tax_amount:te,extra_bed_count:nt,extra_bed_charge:ge,room_card_deposit:q,late_checkout_penalty:se,payment_method:_e,payment_status:U,amount_paid:he,deposit_paid:U!=="unpaid",deposit_amount:U==="unpaid"?0:he}),Qe(),je()}catch(P){T(P.message||"Failed to create booking")}finally{rt(!1)}},A=()=>{if(!k||!I)return 0;const i=new Date(k),u=new Date(I);return Math.ceil((u.getTime()-i.getTime())/(1e3*60*60*24))},Ie=()=>{if(!h)return 0;const i=A();return(typeof h.price_per_night=="string"?parseFloat(h.price_per_night):h.price_per_night)*i},St=()=>Ie()+q+te+ge+se;return e.jsxs(Pe,{open:N,onClose:je,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Re,{children:[e.jsxs(l,{display:"flex",alignItems:"center",children:[e.jsx(vt,{sx:{mr:1,color:"primary.main"}}),e.jsxs(n,{variant:"h6",children:["Quick Booking - Room ",h==null?void 0:h.room_number]})]}),e.jsxs(n,{variant:"caption",color:"text.secondary",children:[h==null?void 0:h.room_type," • ",L(typeof(h==null?void 0:h.price_per_night)=="string"?parseFloat(h.price_per_night):(h==null?void 0:h.price_per_night)||0),"/night"]})]}),e.jsx(Be,{dividers:!0,children:e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:3},children:[Me&&e.jsx(Q,{severity:"error",onClose:()=>T(null),children:Me}),!R&&e.jsxs(l,{children:[e.jsx(n,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:600},children:"Guest Selection"}),e.jsx(Is,{options:$,getOptionLabel:i=>`${i.full_name} (${i.email})`,loading:Xe,value:Le,onChange:(i,u)=>{Ee(u),le(!1)},onInputChange:(i,u)=>lt(u),renderInput:i=>e.jsx(c,{...i,label:"Search Guest",placeholder:"Type guest name or email...",InputProps:{...i.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[Xe?e.jsx(Oe,{color:"inherit",size:20}):null,i.InputProps.endAdornment]})}}),renderOption:(i,u)=>{const{key:b,...P}=i;return e.jsx("li",{...P,children:e.jsxs(l,{children:[e.jsx(n,{variant:"body2",sx:{fontWeight:600},children:u.full_name}),e.jsxs(n,{variant:"caption",color:"text.secondary",children:[u.email," ",u.phone&&`• ${u.phone}`]})]})},b)},disabled:H}),!Le&&!H&&e.jsx(p,{startIcon:e.jsx(Ws,{}),onClick:()=>le(!0),sx:{mt:1},variant:"outlined",size:"small",children:"Register New Guest"})]}),R&&e.jsxs(Q,{severity:"info",children:["Booking for: ",e.jsx("strong",{children:(j==null?void 0:j.full_name)||(j==null?void 0:j.username)})]}),!R&&H&&e.jsxs(ft,{elevation:0,sx:{p:2,bgcolor:"grey.50",borderRadius:2},children:[e.jsxs(l,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(n,{variant:"subtitle2",sx:{fontWeight:600},children:"New Guest Registration"}),e.jsx(p,{size:"small",onClick:()=>{le(!1),f(""),fe(""),Z(""),E("")},children:"Cancel"})]}),e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"First Name",value:X,onChange:i=>f(i.target.value),required:!0,size:"small"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Last Name",value:J,onChange:i=>fe(i.target.value),size:"small"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Email",type:"email",value:ce,onChange:i=>{Z(i.target.value),ye("")},onBlur:()=>ye(zt(ce)),error:!!Je,helperText:Je,required:!0,size:"small"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Phone (Optional)",value:_,onChange:i=>{E(i.target.value),et("")},onBlur:()=>et(""),error:!!Ze,helperText:Ze,size:"small"})})]})]}),e.jsx(yt,{}),e.jsxs(l,{children:[e.jsx(n,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:600},children:"Booking Details"}),e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(Ft,{label:"Check-in Date",value:k,onChange:B,minDate:new Date().toISOString().split("T")[0],required:!0,margin:"none"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Check-in Time",type:"time",value:de,onChange:i=>D(i.target.value),InputLabelProps:{shrink:!0},required:!0,helperText:`Default: ${new Date(`2000-01-01T${re}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}`})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(Ft,{label:"Check-out Date",value:I,onChange:ze,minDate:k||new Date().toISOString().split("T")[0],required:!0,margin:"none"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Check-out Time",type:"time",value:ee,onChange:i=>W(i.target.value),InputLabelProps:{shrink:!0},required:!0,helperText:`Default: ${new Date(`2000-01-01T${ie}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}`})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsxs(c,{select:!0,fullWidth:!0,label:"Post Type",value:tt,onChange:i=>be(i.target.value),SelectProps:{native:!0},children:[e.jsx("option",{value:"normal_stay",children:"Normal Stay"}),e.jsx("option",{value:"same_day",children:"Same Day"})]})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsxs(c,{select:!0,fullWidth:!0,label:"Rate Code",value:st,onChange:i=>ue(i.target.value),SelectProps:{native:!0},children:[e.jsx("option",{value:"RACK",children:"RACK (Standard Rate)"}),e.jsx("option",{value:"OVR",children:"OVR (Override Rate)"})]})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(c,{fullWidth:!0,label:"Booking Remarks (Visible on Dashboard)",multiline:!0,rows:3,value:ve,onChange:i=>z(i.target.value),placeholder:"Add any special notes or requests for this booking...",helperText:"These remarks will be visible on the booking dashboard"})})]})]}),e.jsxs(l,{children:[e.jsx(n,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:600},children:"Payment & Additional Charges"}),e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{select:!0,fullWidth:!0,label:"Payment Method",value:_e,onChange:i=>xe(i.target.value),SelectProps:{native:!0},required:!0,children:it.map(i=>e.jsx("option",{value:i,children:i},i))})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Room Card Deposit",type:"number",value:q,onChange:i=>Se(parseFloat(i.target.value)||0),InputProps:{startAdornment:e.jsx(n,{sx:{mr:.5},children:F})},helperText:"Refundable deposit for room card"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsxs(c,{select:!0,fullWidth:!0,label:"Payment Status",value:U,onChange:i=>v(i.target.value),SelectProps:{native:!0},required:!0,children:[e.jsx("option",{value:"unpaid",children:"Unpaid"}),e.jsx("option",{value:"unpaid_deposit",children:"Deposit Paid"}),e.jsx("option",{value:"paid",children:"Fully Paid"})]})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Amount Paid",type:"number",value:he,onChange:i=>S(parseFloat(i.target.value)||0),InputProps:{startAdornment:e.jsx(n,{sx:{mr:.5},children:F})},disabled:U==="unpaid",helperText:U==="unpaid"?"Set payment status to enter amount":"Enter amount received from guest"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(jt,{control:e.jsx(Xt,{checked:V,onChange:i=>Ce(i.target.checked),color:"primary"}),label:e.jsxs(l,{children:[e.jsx(n,{variant:"body2",sx:{fontWeight:600},children:"Guest is a Tourist"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Tourism tax will be applied automatically"})]}),sx:{mt:1}})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Tourism Tax (Auto-calculated)",type:"number",value:te,InputProps:{startAdornment:e.jsx(n,{sx:{mr:.5},children:F}),readOnly:!0},disabled:!V,helperText:V?`${A()} night(s) × ${L(Ve().tourism_tax_rate)}/night`:'Check "Guest is a Tourist" to apply'})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Number of Extra Beds",type:"number",value:nt,onChange:i=>{const u=parseInt(i.target.value)||0;me(u),Ge(u*50)},inputProps:{min:0,max:5},helperText:`${L(50)} per extra bed`})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Extra Bed Charge",type:"number",value:ge,onChange:i=>Ge(parseFloat(i.target.value)||0),InputProps:{startAdornment:e.jsx(n,{sx:{mr:.5},children:F})},helperText:"Auto-calculated or manually adjust"})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(c,{fullWidth:!0,label:"Late Checkout Penalty (If applicable)",type:"number",value:se,onChange:i=>at(parseFloat(i.target.value)||0),InputProps:{startAdornment:e.jsx(n,{sx:{mr:.5},children:F})},helperText:"Applied if guest checks out after the designated time"})})]})]}),k&&I&&e.jsxs(ft,{elevation:0,sx:{p:2,bgcolor:"primary.50",borderRadius:2},children:[e.jsx(n,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:600},children:"Booking Summary"}),e.jsxs(a,{container:!0,spacing:1,children:[e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Room:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsxs(n,{variant:"body2",sx:{fontWeight:600},children:[h==null?void 0:h.room_number," - ",h==null?void 0:h.room_type]})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Duration:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsxs(n,{variant:"body2",sx:{fontWeight:600},children:[A()," night(s)"]})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Room Rate:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",sx:{fontWeight:600},children:L(Ie())})}),q>0&&e.jsxs(e.Fragment,{children:[e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Room Card Deposit:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",children:L(q)})})]}),te>0&&e.jsxs(e.Fragment,{children:[e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Tourism Tax:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",children:L(te)})})]}),ge>0&&e.jsxs(e.Fragment,{children:[e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Extra Bed:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",children:L(ge)})})]}),se>0&&e.jsxs(e.Fragment,{children:[e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Late Checkout Penalty:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",children:L(se)})})]}),e.jsx(a,{item:!0,xs:12,children:e.jsx(yt,{sx:{my:1}})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",color:"text.secondary",children:"Payment Method:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body2",sx:{fontWeight:600},children:_e})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"body1",sx:{fontWeight:700},children:"Grand Total:"})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(n,{variant:"h6",color:"primary",sx:{fontWeight:700},children:L(St())})})]})]})]})}),e.jsxs(Ae,{children:[e.jsx(p,{onClick:je,disabled:we,children:"Cancel"}),e.jsx(p,{onClick:ot,variant:"contained",disabled:we||!R&&!Le&&!H||R&&!oe||!k||!I||!de||!ee,startIcon:we?e.jsx(Oe,{size:20}):e.jsx(vt,{}),children:we?"Creating Booking...":"Confirm Booking"})]})]})},yn=()=>{const{hasRole:N,hasPermission:je,user:h}=Qt(),Qe=N("admin")||je("rooms:write"),re=N("admin")||N("receptionist")||je("bookings:create"),ie=N("guest")&&!N("admin"),{symbol:R,format:j}=Yt(),[F,L]=r.useState([]),[$,Ye]=r.useState([]),[Le,Ee]=r.useState([]),[Xe,Fe]=r.useState([]),[H,le]=r.useState([]),[oe,Y]=r.useState(!0),[X,f]=r.useState(null),[J,fe]=r.useState(null),[ce,Z]=r.useState(!1),[_,E]=r.useState({}),[Je,ye]=r.useState(!1),[Ze,et]=r.useState(null),k=t=>{if(!t)return null;const s=[],o=Math.floor(t),x=t%1>=.5;for(let g=0;g<o;g++)s.push(e.jsx(Es,{sx:{fontSize:16,color:"#FFB400"}},`full-${g}`));x&&s.push(e.jsx(zs,{sx:{fontSize:16,color:"#FFB400"}},"half"));const O=5-Math.ceil(t);for(let g=0;g<O;g++)s.push(e.jsx(Fs,{sx:{fontSize:16,color:"#FFB400"}},`empty-${g}`));return s},[B,de]=r.useState(""),[D,I]=r.useState(""),[ze,ee]=r.useState(!1),[W,ve]=r.useState(null),[z,tt]=r.useState(null),[be,st]=r.useState([]),[ue,_e]=r.useState(""),[xe,U]=r.useState(""),[v,he]=r.useState(""),[S,q]=r.useState(""),[Se,V]=r.useState("normal_stay"),[Ce,te]=r.useState("RACK"),[ke,nt]=r.useState("Cash"),[me,ge]=r.useState(!1),[Ge,se]=r.useState(0),[at,we]=r.useState(0),[rt,Me]=r.useState(0),[T,it]=r.useState(!1),bt=["Cash","Agoda","Booking.com","Expedia","Traveloka","Visa Card","Debit Card","Master Card","Extra Bed","Tourism Tax","City Ledger (Company Master)","Qrpay","Bank Transfer","Sarawak Pay","Boost"],[_t,lt]=r.useState(!1),[d,ot]=r.useState(null),[A,Ie]=r.useState([]),[St,i]=r.useState(!1),[u,b]=r.useState(!1),[P,K]=r.useState(""),[Jt,ct]=r.useState(!1),[dt,Ct]=r.useState("15:00"),[ut,kt]=r.useState("11:00"),[Zt,xt]=r.useState(!1),[m,We]=r.useState({cleaning_hours_start:"08:00:00",cleaning_hours_end:"16:00:00",auto_cleaning_enabled:"true",cleaning_duration_minutes:"30",cleaning_grace_period_hours:"2"}),[wt,Ot]=r.useState(!1),[It,Ne]=r.useState(!1),es=["Deluxe","Standard","Suite"];r.useEffect(()=>{const t=localStorage.getItem("defaultCheckInTime"),s=localStorage.getItem("defaultCheckOutTime");t&&Ct(t),s&&kt(s)},[]),r.useEffect(()=>{$e()},[]),r.useEffect(()=>{ls()},[F,B,D]),r.useEffect(()=>{if(me&&v&&S){const t=Ve(),s=new Date(v),o=new Date(S),x=Math.ceil((o.getTime()-s.getTime())/(1e3*60*60*24));se(x*t.tourism_tax_rate)}else se(0)},[me,v,S]);const $e=async()=>{try{Y(!0);const[t,s]=await Promise.all([y.getAllRooms(),y.getBookingsWithDetails()]);L(t),Ee(s);const o=ss(t,s);Ye(o),f(null)}catch{f("Failed to load rooms")}finally{Y(!1)}},ts=async()=>{if(window.confirm("Are you sure you want to end all cleaning sessions? All rooms currently being cleaned will be set to available.")){Ne(!0);try{const o=(await y.getAllRooms()).filter(x=>x.status==="cleaning");if(o.length===0){K("No rooms are currently being cleaned."),b(!0),Ne(!1);return}await Promise.all(o.map(x=>y.updateRoomStatus(x.id,{status:"available",notes:"Cleaning ended manually by administrator"}))),await $e(),K(`Successfully ended cleaning for ${o.length} room(s).`),b(!0)}catch(s){console.error("Failed to end all cleaning:",s),f(s.message||"Failed to end all cleaning sessions")}finally{Ne(!1)}}},ss=(t,s)=>{const o=new Date;return o.setHours(0,0,0,0),t.map(x=>{let O="available",g,ht,mt,gt;const He=s.find(w=>{if(String(w.room_id)!==String(x.id))return!1;const ne=new Date(w.check_in_date),Et=new Date(w.check_out_date);return ne.setHours(0,0,0,0),Et.setHours(0,0,0,0),(w.status==="checked_in"||w.status==="auto_checked_in")&&ne<=o&&Et>=o}),Ue=s.find(w=>{if(String(w.room_id)!==String(x.id))return!1;const ne=new Date(w.check_in_date);return ne.setHours(0,0,0,0),(w.status==="pending"||w.status==="confirmed")&&ne.getTime()===o.getTime()}),qe=s.find(w=>{if(String(w.room_id)!==String(x.id))return!1;const ne=new Date(w.check_in_date);return ne.setHours(0,0,0,0),(w.status==="pending"||w.status==="confirmed")&&ne>o});return He?(O="occupied",g=He.guest_name,ht=He.check_in_date,mt=He.check_out_date,gt=String(He.id)):Ue?(O="reserved",g=Ue.guest_name,ht=Ue.check_in_date,mt=Ue.check_out_date,gt=String(Ue.id)):qe?(O="reserved",g=qe.guest_name,ht=qe.check_in_date,mt=qe.check_out_date,gt=String(qe.id)):x.status&&["maintenance","cleaning","dirty"].includes(x.status)?O=x.status:O="available",{...x,computedStatus:O,currentGuest:g,checkInDate:ht,checkOutDate:mt,bookingId:gt}})},ns=t=>{switch(t){case"available":return"success";case"occupied":return"error";case"reserved":return"warning";case"cleaning":return"info";case"dirty":return"error";case"maintenance":return"default";default:return"default"}},as=t=>{switch(t){case"available":return"Available";case"occupied":return"Occupied";case"reserved":return"Reserved";case"cleaning":return"Cleaning";case"dirty":return"Dirty";case"maintenance":return"Maintenance";default:return t}},rs=t=>{const s={sx:{fontSize:16,mr:.5}};switch(t){case"available":return e.jsx(Ut,{...s});case"occupied":return e.jsx(Nt,{...s});case"reserved":return e.jsx($t,{...s});case"cleaning":return e.jsx(pt,{...s});case"dirty":return e.jsx(Pt,{...s});case"maintenance":return e.jsx(Ht,{...s});default:return null}},G=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric"}),is=t=>{const s={};return t.forEach(o=>{s[o.room_type]||(s[o.room_type]={room_type:o.room_type,available_count:0,total_count:0,available_rooms:[],price_per_night:typeof o.price_per_night=="string"?parseFloat(o.price_per_night):o.price_per_night,max_occupancy:o.max_occupancy,description:o.description,average_rating:0,review_count:0}),s[o.room_type].total_count++;const x=$.find(g=>g.id===o.id);if((x==null?void 0:x.computedStatus)==="available"&&(s[o.room_type].available_count++,s[o.room_type].available_rooms.push(o)),o.average_rating&&o.review_count){const g=s[o.room_type];(!g.average_rating||g.average_rating===0)&&(g.average_rating=o.average_rating,g.review_count=o.review_count)}}),Object.values(s)},Lt=()=>H.filter(t=>t.available_count===0&&t.total_count>0).map(t=>t.room_type),ls=()=>{let t=F;if(!Qe){const o=new Set($.filter(x=>x.computedStatus==="available").map(x=>x.id));t=t.filter(x=>o.has(x.id))}if(B&&(t=t.filter(o=>o.room_type.toLowerCase().includes(B.toLowerCase()))),D){const o=parseFloat(D);isNaN(o)||(t=t.filter(x=>(typeof x.price_per_night=="string"?parseFloat(x.price_per_night):x.price_per_night)<=o))}Fe(t);const s=is(t);le(s)},os=async()=>{try{Y(!0);const t=await y.searchRooms(B||void 0,D?parseFloat(D):void 0);Fe(t),f(null)}catch{f("Failed to search rooms")}finally{Y(!1)}},cs=t=>{fe(t),E({room_number:t.room_number,room_type:t.room_type,price_per_night:typeof t.price_per_night=="string"?parseFloat(t.price_per_night):t.price_per_night,available:t.available,description:t.description,max_occupancy:t.max_occupancy}),Z(!0)},ds=async()=>{if(J)try{Y(!0),f(null),await y.updateRoom(J.id,_),K("Room updated successfully"),b(!0),Z(!1),await $e()}catch(t){console.error("Failed to update room:",t),t.statusCode===401?f("Unauthorized: You do not have permission to update rooms. Please contact an administrator."):t.statusCode===403?f('Forbidden: You do not have the required "rooms:write" permission.'):f(t.message||"Failed to update room")}finally{Y(!1)}},us=t=>{et(t),ye(!0)},xs=()=>{K("Booking created successfully!"),b(!0),$e()},hs=()=>{localStorage.setItem("defaultCheckInTime",dt),localStorage.setItem("defaultCheckOutTime",ut),ct(!1),K("Check-in/Check-out times updated successfully!"),b(!0)},ms=async()=>{Ot(!0);try{const t=await y.getSystemSettings(),s={};t.forEach(o=>{(o.key.startsWith("cleaning_")||o.key.startsWith("auto_cleaning"))&&(s[o.key]=o.value)}),We({cleaning_hours_start:s.cleaning_hours_start||"08:00:00",cleaning_hours_end:s.cleaning_hours_end||"16:00:00",auto_cleaning_enabled:s.auto_cleaning_enabled||"true",cleaning_duration_minutes:s.cleaning_duration_minutes||"30",cleaning_grace_period_hours:s.cleaning_grace_period_hours||"2"})}catch(t){console.error("Failed to load cleaning settings:",t),f("Failed to load cleaning settings")}finally{Ot(!1)}},gs=async()=>{Ne(!0);try{await Promise.all([y.updateSystemSetting("cleaning_hours_start",m.cleaning_hours_start),y.updateSystemSetting("cleaning_hours_end",m.cleaning_hours_end),y.updateSystemSetting("auto_cleaning_enabled",m.auto_cleaning_enabled),y.updateSystemSetting("cleaning_duration_minutes",m.cleaning_duration_minutes),y.updateSystemSetting("cleaning_grace_period_hours",m.cleaning_grace_period_hours)]),xt(!1),K("Cleaning settings updated successfully!"),b(!0)}catch(t){console.error("Failed to save cleaning settings:",t),f(t.message||"Failed to save cleaning settings")}finally{Ne(!1)}},ps=async()=>{xt(!0),await ms()},js=t=>{tt(t),st(t.available_rooms),t.available_rooms.length>0&&ve(t.available_rooms[0]);const s=new Date().toISOString().split("T")[0],o=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];he(s),q(o),ee(!0)},fs=async()=>{if(!W||!ue||!xe||!v||!S){f("Please fill in all required fields including dates");return}const t=new Date(v);if(new Date(S)<=t){f("Check-out date must be after check-in date");return}try{it(!0);const o=ue.trim().split(" "),x=o[0]||"",O=o.slice(1).join(" ")||"",g=await y.createGuest({first_name:x,last_name:O,email:xe});await y.createBooking({guest_id:g.id,room_id:W.id,check_in_date:v,check_out_date:S,post_type:Se,rate_code:Ce}),K(`Booking confirmed! Check-in: ${v}, Check-out: ${S}`),b(!0),_e(""),U(""),he(""),q(""),V("normal_stay"),te("RACK"),ee(!1),ve(null),await $e()}catch{f("Failed to create booking")}finally{it(!1)}},ys=()=>{de(""),I("")},vs=async t=>{ot(t),lt(!0),i(!0);try{const s=await y.getRoomReviews(t.room_type);console.log(`Fetched ${s.length} reviews for room type: ${t.room_type}`),console.log("Reviews:",s),Ie(s)}catch(s){console.error("Failed to load reviews:",s),Ie([])}finally{i(!1)}},Wt=()=>{lt(!1),ot(null),Ie([])};if(oe&&F.length===0)return e.jsx(l,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(Oe,{})});const bs=()=>{const t={available:0,occupied:0,reserved:0,cleaning:0,dirty:0,maintenance:0,total:$.length};return $.forEach(s=>{t[s.computedStatus]++}),t};if(Qe){const t=bs();return e.jsxs(l,{sx:{p:3},children:[e.jsx(Gt,{open:u,autoHideDuration:6e3,onClose:()=>b(!1),message:P}),e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(n,{variant:"h4",sx:{fontWeight:700},children:"Room Management"}),e.jsxs(l,{sx:{display:"flex",gap:2},children:[e.jsx(p,{variant:"outlined",startIcon:e.jsx(Mt,{}),onClick:()=>ct(!0),sx:{borderRadius:2},children:"Check-in/Out Times"}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(pt,{}),onClick:ps,sx:{borderRadius:2},children:"Auto-Cleaning Settings"})]})]}),X&&e.jsx(Q,{severity:"error",sx:{mb:2},children:X}),e.jsxs(a,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(M,{sx:{bgcolor:"success.light",color:"success.contrastText"},children:e.jsx(pe,{sx:{py:2},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsx(n,{variant:"caption",sx:{opacity:.9},children:"Available"}),e.jsx(n,{variant:"h4",sx:{fontWeight:700},children:t.available})]}),e.jsx(Ut,{sx:{fontSize:40,opacity:.7}})]})})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(M,{sx:{bgcolor:"error.light",color:"error.contrastText"},children:e.jsx(pe,{sx:{py:2},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsx(n,{variant:"caption",sx:{opacity:.9},children:"Occupied"}),e.jsx(n,{variant:"h4",sx:{fontWeight:700},children:t.occupied})]}),e.jsx(Nt,{sx:{fontSize:40,opacity:.7}})]})})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(M,{sx:{bgcolor:"warning.light",color:"warning.contrastText"},children:e.jsx(pe,{sx:{py:2},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsx(n,{variant:"caption",sx:{opacity:.9},children:"Reserved"}),e.jsx(n,{variant:"h4",sx:{fontWeight:700},children:t.reserved})]}),e.jsx($t,{sx:{fontSize:40,opacity:.7}})]})})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(M,{sx:{bgcolor:"info.light",color:"info.contrastText"},children:e.jsx(pe,{sx:{py:2},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsx(n,{variant:"caption",sx:{opacity:.9},children:"Cleaning"}),e.jsx(n,{variant:"h4",sx:{fontWeight:700},children:t.cleaning})]}),e.jsx(pt,{sx:{fontSize:40,opacity:.7}})]})})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(M,{sx:{bgcolor:"error.main",color:"error.contrastText"},children:e.jsx(pe,{sx:{py:2},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsx(n,{variant:"caption",sx:{opacity:.9},children:"Dirty"}),e.jsx(n,{variant:"h4",sx:{fontWeight:700},children:t.dirty})]}),e.jsx(Pt,{sx:{fontSize:40,opacity:.7}})]})})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(M,{sx:{bgcolor:"grey.400",color:"grey.900"},children:e.jsx(pe,{sx:{py:2},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsx(n,{variant:"caption",sx:{opacity:.9},children:"Maintenance"}),e.jsx(n,{variant:"h4",sx:{fontWeight:700},children:t.maintenance})]}),e.jsx(Ht,{sx:{fontSize:40,opacity:.7}})]})})})})]}),e.jsx(M,{children:e.jsx(Ts,{children:e.jsxs(Ds,{children:[e.jsx(Ps,{children:e.jsxs(qt,{children:[e.jsx(C,{children:"Room Number"}),e.jsx(C,{children:"Room Type"}),e.jsx(C,{children:"Status"}),e.jsx(C,{children:"Details"}),e.jsx(C,{children:"Price/Night"}),e.jsx(C,{children:"Max Occupancy"}),e.jsx(C,{children:"Description"}),e.jsx(C,{align:"right",children:"Actions"})]})}),e.jsx(Rs,{children:$.map(s=>e.jsxs(qt,{children:[e.jsx(C,{children:e.jsx(n,{variant:"body2",sx:{fontWeight:600},children:s.room_number})}),e.jsx(C,{children:e.jsx(De,{label:s.room_type,size:"small",color:"primary",variant:"outlined"})}),e.jsx(C,{children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(De,{icon:rs(s.computedStatus),label:as(s.computedStatus),size:"small",color:ns(s.computedStatus),sx:{fontWeight:600,minWidth:100,"& .MuiChip-icon":{color:"inherit"}}}),s.computedStatus!==s.status&&s.status&&e.jsx(Te,{title:`Backend status: ${s.status} (overridden by booking data)`,children:e.jsx(Rt,{sx:{fontSize:16,color:"warning.main",cursor:"help"}})})]})}),e.jsxs(C,{children:[s.computedStatus==="occupied"&&s.currentGuest&&e.jsx(Te,{title:`Check-in: ${G(s.checkInDate)}, Check-out: ${G(s.checkOutDate)}`,children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Tt,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(n,{variant:"caption",sx:{color:"text.secondary"},children:s.currentGuest})]})}),s.computedStatus==="reserved"&&s.currentGuest&&e.jsx(Te,{title:`Check-in: ${G(s.checkInDate)}, Check-out: ${G(s.checkOutDate)}`,children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Tt,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(n,{variant:"caption",sx:{color:"text.secondary"},children:s.currentGuest})]})}),s.computedStatus==="maintenance"&&s.maintenance_start_date&&e.jsx(Te,{title:`Maintenance: ${G(s.maintenance_start_date)} - ${s.maintenance_end_date?G(s.maintenance_end_date):"TBD"}`,children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Rt,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(n,{variant:"caption",sx:{color:"text.secondary"},children:G(s.maintenance_start_date)})]})}),s.computedStatus==="cleaning"&&s.cleaning_start_date&&e.jsx(Te,{title:`Cleaning: ${G(s.cleaning_start_date)} - ${s.cleaning_end_date?G(s.cleaning_end_date):"TBD"}`,children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Rt,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(n,{variant:"caption",sx:{color:"text.secondary"},children:G(s.cleaning_start_date)})]})}),s.computedStatus==="dirty"&&e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Pt,{sx:{fontSize:14,color:"error.main"}}),e.jsx(n,{variant:"caption",sx:{color:"error.main",fontWeight:600},children:"Needs cleaning"})]}),s.computedStatus==="available"&&e.jsx(n,{variant:"caption",sx:{color:"text.secondary",fontStyle:"italic"},children:"Ready to book"})]}),e.jsx(C,{children:j(typeof s.price_per_night=="string"?parseFloat(s.price_per_night):s.price_per_night)}),e.jsxs(C,{children:[s.max_occupancy," guests"]}),e.jsx(C,{sx:{maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:s.description}),e.jsx(C,{align:"right",children:e.jsxs(l,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[re&&s.computedStatus==="available"&&e.jsx(p,{size:"small",variant:"contained",color:"success",onClick:()=>us(s),startIcon:e.jsx(vt,{}),children:"Quick Book"}),e.jsx(Te,{title:s.computedStatus==="occupied"?"Cannot edit occupied room. Please check out the guest first.":"Edit room details",children:e.jsx("span",{children:e.jsx(_s,{size:"small",onClick:()=>cs(s),color:"primary",disabled:s.computedStatus==="occupied",children:e.jsx(As,{})})})})]})})]},s.id))})]})})}),e.jsx($s,{open:Je,onClose:()=>ye(!1),room:Ze,onBookingSuccess:xs,defaultCheckInTime:dt,defaultCheckOutTime:ut,guestMode:ie}),e.jsxs(Pe,{open:Jt,onClose:()=>ct(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Re,{children:e.jsxs(l,{display:"flex",alignItems:"center",children:[e.jsx(Mt,{sx:{mr:1,color:"primary.main"}}),e.jsx(n,{variant:"h6",children:"Default Check-in/Check-out Times"})]})}),e.jsxs(Be,{children:[e.jsx(Q,{severity:"info",sx:{mb:3},children:"Set the default times for check-in and check-out. These will be used when creating new bookings."}),e.jsxs(a,{container:!0,spacing:3,sx:{mt:1},children:[e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Check-in Time",type:"time",value:dt,onChange:s=>Ct(s.target.value),InputLabelProps:{shrink:!0},helperText:"Default: 3:00 PM (15:00)"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Check-out Time",type:"time",value:ut,onChange:s=>kt(s.target.value),InputLabelProps:{shrink:!0},helperText:"Default: 11:00 AM (11:00)"})}),e.jsx(a,{item:!0,xs:12,children:e.jsxs(ft,{elevation:0,sx:{p:2,bgcolor:"grey.50",borderRadius:2},children:[e.jsx(n,{variant:"subtitle2",sx:{fontWeight:600,mb:1},children:"Current Settings Preview"}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Check-in: ",new Date(`2000-01-01T${dt}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})]}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Check-out: ",new Date(`2000-01-01T${ut}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})]})]})})]})]}),e.jsxs(Ae,{children:[e.jsx(p,{onClick:()=>{ct(!1);const s=localStorage.getItem("defaultCheckInTime")||"15:00",o=localStorage.getItem("defaultCheckOutTime")||"11:00";Ct(s),kt(o)},startIcon:e.jsx(Bt,{}),children:"Cancel"}),e.jsx(p,{onClick:hs,variant:"contained",startIcon:e.jsx(At,{}),children:"Save Settings"})]})]}),e.jsxs(Pe,{open:Zt,onClose:()=>xt(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Re,{children:e.jsxs(l,{display:"flex",alignItems:"center",children:[e.jsx(pt,{sx:{mr:1,color:"primary.main"}}),e.jsx(n,{variant:"h6",children:"Auto-Cleaning Configuration"})]})}),e.jsx(Be,{children:wt?e.jsx(l,{display:"flex",justifyContent:"center",py:4,children:e.jsx(Oe,{})}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{severity:"info",sx:{mb:3},children:"Configure automatic cleaning scheduling for rooms. When enabled, the system will automatically set rooms to cleaning status when they become available during cleaning hours."}),e.jsxs(a,{container:!0,spacing:3,sx:{mt:1},children:[e.jsx(a,{item:!0,xs:12,children:e.jsx(jt,{control:e.jsx(Vt,{checked:m.auto_cleaning_enabled==="true",onChange:s=>We({...m,auto_cleaning_enabled:s.target.checked?"true":"false"}),color:"primary"}),label:e.jsxs(l,{children:[e.jsx(n,{variant:"body1",sx:{fontWeight:600},children:"Enable Auto-Cleaning"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Automatically set rooms to cleaning status when they become available"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Cleaning Hours Start",type:"time",value:m.cleaning_hours_start.substring(0,5),onChange:s=>We({...m,cleaning_hours_start:s.target.value+":00"}),InputLabelProps:{shrink:!0},helperText:"When cleaning service starts",disabled:m.auto_cleaning_enabled!=="true"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Cleaning Hours End",type:"time",value:m.cleaning_hours_end.substring(0,5),onChange:s=>We({...m,cleaning_hours_end:s.target.value+":00"}),InputLabelProps:{shrink:!0},helperText:"When cleaning service ends",disabled:m.auto_cleaning_enabled!=="true"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Cleaning Duration (minutes)",type:"number",value:m.cleaning_duration_minutes,onChange:s=>We({...m,cleaning_duration_minutes:s.target.value}),InputLabelProps:{shrink:!0},helperText:"Expected time to clean a room",inputProps:{min:10,max:180},disabled:m.auto_cleaning_enabled!=="true"})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Grace Period (hours)",type:"number",value:m.cleaning_grace_period_hours,onChange:s=>We({...m,cleaning_grace_period_hours:s.target.value}),InputLabelProps:{shrink:!0},helperText:"Skip cleaning if next booking is within this time",inputProps:{min:0,max:24},disabled:m.auto_cleaning_enabled!=="true"})}),e.jsx(a,{item:!0,xs:12,children:e.jsxs(ft,{elevation:0,sx:{p:2,bgcolor:"grey.50",borderRadius:2},children:[e.jsx(n,{variant:"subtitle2",sx:{fontWeight:600,mb:1},children:"Current Configuration"}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Auto-Cleaning: ",m.auto_cleaning_enabled==="true"?"Enabled":"Disabled"]}),m.auto_cleaning_enabled==="true"&&e.jsxs(e.Fragment,{children:[e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Cleaning Hours: ",m.cleaning_hours_start.substring(0,5)," - ",m.cleaning_hours_end.substring(0,5)]}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Duration: ",m.cleaning_duration_minutes," minutes"]}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Grace Period: ",m.cleaning_grace_period_hours," hours"]})]})]})})]})]})}),e.jsxs(Ae,{sx:{justifyContent:"space-between",px:3,py:2},children:[e.jsx(p,{onClick:ts,variant:"outlined",color:"error",startIcon:e.jsx(Gs,{}),disabled:It||wt,children:"End All Cleaning"}),e.jsxs(l,{sx:{display:"flex",gap:1},children:[e.jsx(p,{onClick:()=>xt(!1),startIcon:e.jsx(Bt,{}),children:"Cancel"}),e.jsx(p,{onClick:gs,variant:"contained",startIcon:e.jsx(At,{}),disabled:It||wt,children:It?"Saving...":"Save Settings"})]})]})]}),e.jsxs(Pe,{open:ce,onClose:()=>Z(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Re,{children:["Edit Room ",J==null?void 0:J.room_number]}),e.jsx(Be,{children:e.jsxs(a,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Room Number",value:_.room_number||"",onChange:s=>E({..._,room_number:s.target.value})})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Room Type",value:_.room_type||"",onChange:s=>E({..._,room_type:s.target.value})})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Price Per Night",type:"number",value:_.price_per_night||"",onChange:s=>E({..._,price_per_night:parseFloat(s.target.value)}),inputProps:{step:"0.01",min:"0"}})}),e.jsx(a,{item:!0,xs:12,sm:6,children:e.jsx(c,{fullWidth:!0,label:"Max Occupancy",type:"number",value:_.max_occupancy||"",onChange:s=>E({..._,max_occupancy:parseInt(s.target.value)}),inputProps:{min:"1"}})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(jt,{control:e.jsx(Vt,{checked:_.available||!1,onChange:s=>E({..._,available:s.target.checked})}),label:"Available for Booking",sx:{width:"100%","& .MuiFormControlLabel-label":{width:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"normal",wordWrap:"break-word"}}})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(c,{fullWidth:!0,label:"Description",multiline:!0,rows:3,value:_.description||"",onChange:s=>E({..._,description:s.target.value})})})]})}),e.jsxs(Ae,{children:[e.jsx(p,{onClick:()=>Z(!1),startIcon:e.jsx(Bt,{}),children:"Cancel"}),e.jsx(p,{onClick:()=>ds(),variant:"contained",startIcon:e.jsx(At,{}),disabled:oe,children:"Save Changes"})]})]})]})}return e.jsxs(l,{children:[e.jsxs(l,{sx:{mb:4},children:[e.jsx(n,{variant:"h4",component:"h1",gutterBottom:!0,sx:{fontWeight:700},children:"Book Room"}),e.jsx(n,{variant:"body1",color:"text.secondary",children:"Browse available rooms and make reservations. Search by type or price to find the perfect room."})]}),X&&e.jsx(Q,{severity:"error",sx:{mb:3},children:X}),e.jsxs(M,{sx:{mb:3,p:3,background:"linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%)"},children:[e.jsxs(l,{display:"flex",alignItems:"center",mb:2,children:[e.jsx(Kt,{sx:{mr:1,color:"primary.main"}}),e.jsx(n,{variant:"h6",sx:{fontWeight:600},children:"Search & Filter Rooms"})]}),e.jsxs(a,{container:!0,spacing:3,alignItems:"center",children:[e.jsx(a,{item:!0,xs:12,sm:4,children:e.jsxs(c,{select:!0,fullWidth:!0,label:"Room Type",value:B,onChange:t=>de(t.target.value),children:[e.jsx(ae,{value:"",children:"All Types"}),es.map(t=>e.jsx(ae,{value:t,children:t},t))]})}),e.jsx(a,{item:!0,xs:12,sm:4,children:e.jsx(c,{fullWidth:!0,label:`Max Price (${R})`,type:"number",value:D,onChange:t=>I(t.target.value),placeholder:"Enter max price"})}),e.jsx(a,{item:!0,xs:12,sm:4,children:e.jsxs(l,{display:"flex",gap:1,children:[e.jsx(p,{variant:"contained",startIcon:e.jsx(Kt,{}),onClick:os,fullWidth:!0,children:"Search"}),e.jsx(p,{variant:"outlined",onClick:ys,children:"Clear"})]})})]})]}),(B||D)&&e.jsxs(l,{mb:2,children:[e.jsx(n,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Active filters:"}),B&&e.jsx(De,{label:`Type: ${B}`,onDelete:()=>de(""),sx:{mr:1}}),D&&e.jsx(De,{label:`Max Price: ${R}${D}`,onDelete:()=>I("")})]}),F.length>0&&Lt().length>0&&e.jsxs(Q,{severity:"warning",sx:{mb:3},children:[e.jsx(n,{variant:"body2",sx:{fontWeight:600,mb:1},children:"Fully Reserved Room Types"}),e.jsx(l,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:Lt().map(t=>e.jsx(De,{label:t,color:"error",size:"small",icon:e.jsx(Dt,{})},t))}),e.jsx(n,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:1},children:"All rooms of these types are currently booked. Please check back later or choose a different room type."})]}),H.length===0?e.jsxs(M,{sx:{p:4,textAlign:"center"},children:[e.jsx(Dt,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(n,{variant:"h6",color:"text.secondary",children:"No rooms found matching your criteria"})]}):e.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:H.map(t=>e.jsx(M,{onClick:()=>vs(t),sx:{border:t.available_count>0?"1px solid #e0e0e0":"1px solid #ffcdd2",transition:"all 0.3s ease",cursor:"pointer","&:hover":{boxShadow:"0px 4px 20px rgba(0,0,0,0.1)",transform:"translateX(4px)"}},children:e.jsx(pe,{sx:{p:2.5},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:3,flexWrap:"wrap"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",minWidth:180},children:[e.jsx(Dt,{sx:{mr:1,color:"primary.main",fontSize:32}}),e.jsxs(l,{children:[e.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:"ROOM TYPE"}),e.jsx(n,{variant:"h5",sx:{fontWeight:700,lineHeight:1.2},children:t.room_type})]})]}),e.jsxs(l,{sx:{minWidth:140},children:[e.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:"AVAILABILITY"}),e.jsxs(n,{variant:"body1",sx:{fontWeight:600,color:t.available_count>0?"success.main":"error.main"},children:[t.available_count," / ",t.total_count," Available"]})]}),e.jsxs(l,{sx:{minWidth:100},children:[e.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:"OCCUPANCY"}),e.jsxs(n,{variant:"body1",sx:{fontWeight:500},children:[t.max_occupancy," ",t.max_occupancy===1?"Guest":"Guests"]})]}),e.jsxs(l,{sx:{minWidth:120},children:[e.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:"PRICE/NIGHT"}),e.jsx(n,{variant:"h6",color:"primary",sx:{fontWeight:700},children:j(t.price_per_night)})]}),t.average_rating&&t.average_rating>0&&e.jsxs(l,{sx:{minWidth:140},children:[e.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:"GUEST RATING"}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(l,{sx:{display:"flex"},children:k(t.average_rating)}),e.jsx(n,{variant:"body2",sx:{fontWeight:600,ml:.5},children:t.average_rating.toFixed(1)}),t.review_count&&t.review_count>0&&e.jsxs(n,{variant:"caption",color:"text.secondary",children:["(",t.review_count," ",t.review_count===1?"review":"reviews",")"]})]})]}),t.description&&e.jsxs(l,{sx:{flex:1,minWidth:200},children:[e.jsx(n,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem"},children:"DESCRIPTION"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:t.description})]}),e.jsx(l,{sx:{display:"flex",alignItems:"center",gap:2,ml:"auto"},children:e.jsx(p,{variant:"contained",disabled:t.available_count===0,onClick:s=>{s.stopPropagation(),js(t)},startIcon:e.jsx(vt,{}),sx:{minWidth:160,fontWeight:600,background:t.available_count>0?"linear-gradient(135deg, #1a73e8 0%, #4285f4 100%)":void 0},children:t.available_count>0?"Book Now":"Fully Booked"})})]})})},t.room_type))}),Xe.length===0&&!oe&&e.jsx(l,{textAlign:"center",py:4,children:e.jsx(n,{variant:"h6",color:"text.secondary",children:"No rooms found matching your criteria"})}),e.jsxs(Pe,{open:ze,onClose:()=>ee(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Re,{children:["Book ",z==null?void 0:z.room_type," Room"]}),e.jsx(Be,{children:e.jsxs(l,{sx:{pt:2},children:[be.length>1&&e.jsx(c,{select:!0,fullWidth:!0,label:"Select Room",value:(W==null?void 0:W.id)||"",onChange:t=>{const s=be.find(o=>o.id===t.target.value);s&&ve(s)},sx:{mb:2},children:be.map(t=>e.jsxs(ae,{value:t.id,children:["Room ",t.room_number," - ",t.room_type]},t.id))}),e.jsx(c,{fullWidth:!0,label:"Guest Name",value:ue,onChange:t=>_e(t.target.value),sx:{mb:2}}),e.jsx(c,{fullWidth:!0,label:"Guest Email",type:"email",value:xe,onChange:t=>U(t.target.value),sx:{mb:2}}),e.jsx(c,{fullWidth:!0,label:"Check-in Date",type:"date",value:v,onChange:t=>he(t.target.value),InputLabelProps:{shrink:!0},inputProps:{min:new Date().toISOString().split("T")[0]},sx:{mb:2}}),e.jsx(c,{fullWidth:!0,label:"Check-out Date",type:"date",value:S,onChange:t=>q(t.target.value),InputLabelProps:{shrink:!0},inputProps:{min:v||new Date().toISOString().split("T")[0]},sx:{mb:2}}),e.jsxs(c,{select:!0,fullWidth:!0,label:"Post Type",value:Se,onChange:t=>V(t.target.value),sx:{mb:2},children:[e.jsx(ae,{value:"normal_stay",children:"Normal Stay"}),e.jsx(ae,{value:"same_day",children:"Same Day"})]}),e.jsxs(c,{select:!0,fullWidth:!0,label:"Rate Code",value:Ce,onChange:t=>te(t.target.value),sx:{mb:2},children:[e.jsx(ae,{value:"RACK",children:"RACK (Standard Rate)"}),e.jsx(ae,{value:"OVR",children:"OVR (Override Rate)"})]}),e.jsx(c,{select:!0,fullWidth:!0,label:"Payment Method",value:ke,onChange:t=>nt(t.target.value),sx:{mb:2},helperText:"Select how the guest will pay for this booking",children:bt.map(t=>e.jsx(ae,{value:t,children:t},t))}),e.jsx(jt,{control:e.jsx(Xt,{checked:me,onChange:t=>ge(t.target.checked),color:"primary"}),label:e.jsxs(l,{children:[e.jsx(n,{variant:"body2",sx:{fontWeight:600},children:"Guest is a Tourist"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Tourism tax will be applied automatically"})]}),sx:{mb:2}}),me&&e.jsx(c,{fullWidth:!0,label:"Tourism Tax (Auto-calculated)",value:j(Ge),InputProps:{readOnly:!0},disabled:!0,helperText:v&&S?`${Math.ceil((new Date(S).getTime()-new Date(v).getTime())/(1e3*60*60*24))} night(s) × ${j(Ve().tourism_tax_rate)}/night`:"Select dates to calculate",sx:{mb:2}}),e.jsxs(a,{container:!0,spacing:2,sx:{mb:2},children:[e.jsx(a,{item:!0,xs:6,children:e.jsx(c,{fullWidth:!0,label:"Number of Extra Beds",type:"number",value:at,onChange:t=>{const s=parseInt(t.target.value)||0;we(s),Me(s*50)},inputProps:{min:0,max:5},helperText:`${j(50)} per extra bed`})}),e.jsx(a,{item:!0,xs:6,children:e.jsx(c,{fullWidth:!0,label:"Extra Bed Charge",type:"number",value:rt,onChange:t=>Me(parseFloat(t.target.value)||0),InputProps:{startAdornment:e.jsx(n,{sx:{mr:.5},children:R})},helperText:"Auto-calculated or adjust manually"})})]}),W&&z&&e.jsxs(l,{sx:{p:2,backgroundColor:"#f5f5f5",borderRadius:1},children:[e.jsx(n,{variant:"body2",sx:{fontWeight:600,mb:1},children:"Booking Summary"}),e.jsxs(n,{variant:"body2",children:["Room Type: ",z.room_type]}),e.jsxs(n,{variant:"body2",children:["Room Number: #",W.room_number]}),e.jsxs(n,{variant:"body2",children:["Available Rooms: ",z.available_count," of ",z.total_count]}),e.jsxs(n,{variant:"body2",children:["Price: ",j(typeof W.price_per_night=="string"?parseFloat(W.price_per_night):W.price_per_night),"/night"]}),e.jsxs(n,{variant:"body2",children:["Post Type: ",Se==="normal_stay"?"Normal Stay":"Same Day"]}),e.jsxs(n,{variant:"body2",children:["Rate Code: ",Ce]}),e.jsxs(n,{variant:"body2",children:["Payment Method: ",ke]}),v&&S&&e.jsxs(n,{variant:"body2",sx:{mt:1,fontWeight:500},children:["Duration: ",Math.ceil((new Date(S).getTime()-new Date(v).getTime())/(1e3*60*60*24))," night(s)"]})]})]})}),e.jsxs(Ae,{children:[e.jsx(p,{onClick:()=>ee(!1),children:"Cancel"}),e.jsx(p,{onClick:fs,variant:"contained",disabled:T||!ue||!xe||!v||!S,children:T?e.jsx(Oe,{size:20}):"Confirm Booking"})]})]}),e.jsx(Gt,{open:u,autoHideDuration:6e3,onClose:()=>b(!1),children:e.jsx(Q,{onClose:()=>b(!1),severity:"success",children:P})}),e.jsxs(Pe,{open:_t,onClose:Wt,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Re,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[e.jsxs(l,{children:[e.jsx(n,{variant:"h5",sx:{fontWeight:700},children:d==null?void 0:d.room_type}),e.jsx(n,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:"All reviews for this room type"}),(d==null?void 0:d.average_rating)&&e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mt:1},children:[e.jsx(l,{sx:{display:"flex"},children:k(d.average_rating)}),e.jsx(n,{variant:"body2",sx:{fontWeight:600},children:d.average_rating.toFixed(1)}),d.review_count&&e.jsxs(n,{variant:"caption",color:"text.secondary",children:["(",d.review_count," ",d.review_count===1?"review":"reviews",")"]})]})]}),e.jsx(p,{onClick:Wt,sx:{minWidth:"auto"},children:e.jsx(Os,{})})]}),e.jsxs(Be,{dividers:!0,children:[e.jsxs(l,{sx:{mb:3},children:[e.jsxs(a,{container:!0,spacing:2,children:[e.jsxs(a,{item:!0,xs:6,sm:3,children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:"Price/Night"}),e.jsx(n,{variant:"h6",color:"primary",sx:{fontWeight:700},children:j((d==null?void 0:d.price_per_night)||0)})]}),e.jsxs(a,{item:!0,xs:6,sm:3,children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:"Occupancy"}),e.jsxs(n,{variant:"body1",sx:{fontWeight:600},children:[d==null?void 0:d.max_occupancy," Guests"]})]}),e.jsxs(a,{item:!0,xs:6,sm:3,children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:"Availability"}),e.jsxs(n,{variant:"body1",sx:{fontWeight:600,color:d&&d.available_count>0?"success.main":"error.main"},children:[d==null?void 0:d.available_count," / ",d==null?void 0:d.total_count]})]}),e.jsxs(a,{item:!0,xs:6,sm:3,children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:"Total Rooms"}),e.jsxs(n,{variant:"body1",sx:{fontWeight:600},children:[d==null?void 0:d.total_count," ",(d==null?void 0:d.total_count)===1?"Room":"Rooms"]})]})]}),(d==null?void 0:d.description)&&e.jsx(l,{sx:{mt:2},children:e.jsx(n,{variant:"body2",color:"text.secondary",children:d.description})})]}),e.jsx(yt,{sx:{my:2}}),e.jsxs(l,{children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(l,{children:[e.jsxs(n,{variant:"h6",sx:{fontWeight:700},children:["Customer Reviews for ",d==null?void 0:d.room_type]}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Reviews from all guests who stayed in this room type"})]}),A.length>0&&e.jsx(De,{label:`${A.length} ${A.length===1?"Review":"Reviews"}`,size:"small",color:"primary",sx:{fontWeight:600}})]}),St?e.jsx(l,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(Oe,{})}):A.length===0?e.jsx(n,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:4},children:"No reviews yet for this room type."}):e.jsxs(l,{children:[A.length>3&&e.jsx(Q,{severity:"info",sx:{mb:2},children:e.jsxs(n,{variant:"body2",children:["Showing all ",A.length," reviews. Scroll down to see more."]})}),e.jsx(Ss,{sx:{maxHeight:600,overflow:"auto",border:"1px solid",borderColor:"divider",borderRadius:1,bgcolor:"background.paper"},children:A.map((t,s)=>e.jsxs(Cs.Fragment,{children:[s>0&&e.jsx(yt,{sx:{my:2}}),e.jsxs(Ls,{alignItems:"flex-start",sx:{px:0},children:[e.jsx(Bs,{children:e.jsx(ks,{sx:{bgcolor:"primary.main"},children:e.jsx(Tt,{})})}),e.jsx(ws,{primary:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(n,{variant:"subtitle2",sx:{fontWeight:600},children:t.guest_name}),t.is_verified&&e.jsx(Ns,{sx:{fontSize:16,color:"primary.main"}}),e.jsx(l,{sx:{display:"flex",ml:"auto"},children:k(t.overall_rating)})]}),secondary:e.jsxs(l,{children:[t.title&&e.jsx(n,{variant:"subtitle2",sx:{fontWeight:600,mt:.5},children:t.title}),t.review_text&&e.jsx(n,{variant:"body2",color:"text.primary",sx:{mt:.5},children:t.review_text}),t.pros&&e.jsxs(l,{sx:{mt:1},children:[e.jsx(n,{variant:"caption",color:"success.main",sx:{fontWeight:600},children:"Pros:"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:t.pros})]}),t.cons&&e.jsxs(l,{sx:{mt:1},children:[e.jsx(n,{variant:"caption",color:"error.main",sx:{fontWeight:600},children:"Cons:"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:t.cons})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mt:1},children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:new Date(t.created_at).toLocaleDateString()}),t.helpful_count>0&&e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Ms,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(n,{variant:"caption",color:"text.secondary",children:t.helpful_count})]})]})]})})]})]},t.id))})]})]})]}),e.jsx(Ae,{children:e.jsx(p,{onClick:Wt,children:"Close"})})]})]})};export{yn as default};
