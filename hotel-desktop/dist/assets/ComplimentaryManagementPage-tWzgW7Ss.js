import{r as n,j as e,B as o,C as Me,T as s,G as Ue,o as p,x as He,A as w,f as qe,aY as Qe,P as Ve,p as se,a0 as Ye,a1 as me,n as v,q as G,I as V,F as Je,y as Ke,S as Xe,t as Ze,H as _}from"./index-DnWmqzJF.js";import{u as et}from"./useCurrency-C4JSCWBJ.js";import{G as l}from"./Grid-0tqG7FTE.js";import{C as Y,a as J}from"./CardContent-BhQI87uj.js";import{M as tt}from"./AttachMoney-oNl3swnH.js";import{I as st}from"./InputAdornment-BrN3aL1-.js";import{S as rt}from"./Search-CErNxQ4Y.js";import{T as nt,a as he,b as ue,c as F,d as r,e as xe}from"./TableRow-B78mTfEk.js";import{T as R}from"./TableSortLabel-zmUvbVTn.js";import{C as K}from"./Chip-CSuofl6d.js";import{E as pe}from"./Edit-v4qS8plG.js";import{D as je}from"./Delete-CC6nSGco.js";import{A as at}from"./Add-C7DSqfba.js";import{D as P,a as E,b as B,c as L}from"./DialogTitle-DKxRfOzX.js";import{A as it}from"./Autocomplete-CZ6UKh6h.js";import{S as lt}from"./Snackbar-BmHWVIFe.js";import"./currency-SgYezy9c.js";function ye(N){const{children:b,value:O,index:f,...X}=N;return e.jsx("div",{role:"tabpanel",hidden:O!==f,...X,children:O===f&&e.jsx(o,{sx:{pt:2},children:b})})}function Dt(){const{format:N}=et(),[b,O]=n.useState([]),[f,X]=n.useState([]),[I,ge]=n.useState(null),[_e,re]=n.useState(!0),[ne,Z]=n.useState(null),[ee,fe]=n.useState(0),[z,Ce]=n.useState(""),[d,ve]=n.useState("created_at"),[C,ae]=n.useState("desc"),[be,$]=n.useState(!1),[Se,M]=n.useState(!1),[i,ie]=n.useState(null),[S,U]=n.useState({complimentary_start_date:"",complimentary_end_date:"",complimentary_reason:""}),[y,g]=n.useState(!1),[T,m]=n.useState({open:!1,message:"",severity:"success"}),[De,H]=n.useState(!1),[ke,q]=n.useState(!1),[we,Q]=n.useState(!1),[h,le]=n.useState(null),[oe,Ie]=n.useState([]),[Te,Ae]=n.useState([]),[c,A]=n.useState({guest_id:0,room_type_id:0,nights:1,notes:""}),[k,te]=n.useState({nights_available:0,notes:""}),D=async()=>{try{re(!0),Z(null);const[t,a,j,u,x]=await Promise.all([_.getComplimentaryBookings(),_.getGuestsWithCredits(),_.getComplimentarySummary(),_.getAllGuests(),_.getRoomTypes()]);O(t||[]),X((a==null?void 0:a.credits)||[]),ge(j),Ie(u||[]),Ae(x||[])}catch(t){Z(t.message||"Failed to load data")}finally{re(!1)}};n.useEffect(()=>{D()},[]);const We=()=>{A({guest_id:0,room_type_id:0,nights:1,notes:""}),H(!0)},Ge=t=>{le(t),te({nights_available:t.nights_available,notes:t.notes||""}),q(!0)},Fe=t=>{le(t),Q(!0)},Re=async()=>{if(!c.guest_id||!c.room_type_id||c.nights<=0){m({open:!0,message:"Please fill in all required fields",severity:"error"});return}try{g(!0),await _.addGuestCredits({guest_id:c.guest_id,room_type_id:c.room_type_id,nights:c.nights,notes:c.notes||void 0}),m({open:!0,message:"Credits added successfully",severity:"success"}),H(!1),await D()}catch(t){m({open:!0,message:t.message||"Failed to add credits",severity:"error"})}finally{g(!1)}},Pe=async()=>{if(h)try{g(!0),await _.updateGuestCredits(h.guest_id,h.room_type_id,{nights_available:k.nights_available,notes:k.notes||void 0}),m({open:!0,message:"Credits updated successfully",severity:"success"}),q(!1),await D()}catch(t){m({open:!0,message:t.message||"Failed to update credits",severity:"error"})}finally{g(!1)}},Ee=async()=>{if(h)try{g(!0),await _.deleteGuestCredits(h.guest_id,h.room_type_id),m({open:!0,message:"Credits deleted successfully",severity:"success"}),Q(!1),await D()}catch(t){m({open:!0,message:t.message||"Failed to delete credits",severity:"error"})}finally{g(!1)}},ce=n.useMemo(()=>{let t=[...b||[]];if(z){const a=z.toLowerCase();t=t.filter(j=>{var u,x,de;return((u=j.guest_name)==null?void 0:u.toLowerCase().includes(a))||((x=j.booking_number)==null?void 0:x.toLowerCase().includes(a))||((de=j.room_number)==null?void 0:de.toLowerCase().includes(a))})}return t.sort((a,j)=>{let u,x;switch(d){case"guest_name":u=a.guest_name||"",x=j.guest_name||"";break;case"room_number":u=a.room_number||"",x=j.room_number||"";break;case"complimentary_nights":u=a.complimentary_nights||0,x=j.complimentary_nights||0;break;case"status":u=a.status||"",x=j.status||"";break;default:u=new Date(a.created_at||0).getTime(),x=new Date(j.created_at||0).getTime()}return u<x?C==="asc"?-1:1:u>x?C==="asc"?1:-1:0}),t},[b,z,d,C]),W=t=>{d===t?ae(C==="asc"?"desc":"asc"):(ve(t),ae("asc"))},Be=t=>{ie(t),U({complimentary_start_date:t.complimentary_start_date||"",complimentary_end_date:t.complimentary_end_date||"",complimentary_reason:t.complimentary_reason||""}),$(!0)},Le=t=>{ie(t),M(!0)},Ne=async()=>{if(i)try{g(!0),await _.updateComplimentary(i.id.toString(),S),m({open:!0,message:"Complimentary booking updated successfully",severity:"success"}),$(!1),await D()}catch(t){m({open:!0,message:t.message||"Failed to update",severity:"error"})}finally{g(!1)}},Oe=async()=>{if(i)try{g(!0),await _.removeComplimentary(i.id.toString()),m({open:!0,message:"Complimentary status removed successfully",severity:"success"}),M(!1),await D()}catch(t){m({open:!0,message:t.message||"Failed to remove",severity:"error"})}finally{g(!1)}},ze=t=>{switch(t){case"fully_complimentary":return"success";case"partial_complimentary":return"warning";case"comp_cancelled":return"info";default:return"default"}},$e=t=>{switch(t){case"fully_complimentary":return"Fully Complimentary";case"partial_complimentary":return"Partial";case"comp_cancelled":return"Comp Cancelled";default:return t}};return _e?e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(Me,{})}):e.jsxs(o,{sx:{p:3},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(s,{variant:"h4",sx:{fontWeight:700,display:"flex",alignItems:"center"},children:[e.jsx(Ue,{sx:{mr:1,fontSize:32}}),"Complimentary Management"]}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(He,{}),onClick:D,children:"Refresh"})]}),ne&&e.jsx(w,{severity:"error",sx:{mb:2},onClose:()=>Z(null),children:ne}),I&&e.jsxs(l,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(Y,{children:e.jsxs(J,{children:[e.jsxs(o,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(qe,{color:"primary",sx:{mr:1}}),e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Complimentary Bookings"})]}),e.jsx(s,{variant:"h4",color:"primary",children:I.total_complimentary_bookings})]})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(Y,{children:e.jsxs(J,{children:[e.jsxs(o,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(Qe,{color:"secondary",sx:{mr:1}}),e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Nights Given"})]}),e.jsx(s,{variant:"h4",color:"secondary",children:I.total_complimentary_nights})]})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(Y,{children:e.jsxs(J,{children:[e.jsxs(o,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(Ve,{color:"info",sx:{mr:1}}),e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Credits Available"})]}),e.jsx(s,{variant:"h4",color:"info.main",children:I.total_credits_available}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"(room-type specific credits)"})]})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(Y,{children:e.jsxs(J,{children:[e.jsxs(o,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(tt,{color:"success",sx:{mr:1}}),e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Value Given"})]}),e.jsx(s,{variant:"h4",color:"success.main",children:N(parseFloat(I.value_of_complimentary_nights)||0)})]})})})]}),e.jsx(se,{sx:{mb:2},children:e.jsxs(Ye,{value:ee,onChange:(t,a)=>fe(a),children:[e.jsx(me,{label:`Complimentary Bookings (${(b==null?void 0:b.length)||0})`}),e.jsx(me,{label:`Guest Credits (${(f==null?void 0:f.length)||0})`})]})}),e.jsxs(ye,{value:ee,index:0,children:[e.jsx(v,{fullWidth:!0,variant:"outlined",placeholder:"Search by guest, booking number, or room...",value:z,onChange:t=>Ce(t.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(st,{position:"start",children:e.jsx(rt,{})})}}),e.jsx(nt,{component:se,children:e.jsxs(he,{children:[e.jsx(ue,{children:e.jsxs(F,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{children:e.jsx(R,{active:d==="created_at",direction:d==="created_at"?C:"asc",onClick:()=>W("created_at"),children:e.jsx("strong",{children:"Booking #"})})}),e.jsx(r,{children:e.jsx(R,{active:d==="guest_name",direction:d==="guest_name"?C:"asc",onClick:()=>W("guest_name"),children:e.jsx("strong",{children:"Guest"})})}),e.jsx(r,{children:e.jsx(R,{active:d==="room_number",direction:d==="room_number"?C:"asc",onClick:()=>W("room_number"),children:e.jsx("strong",{children:"Room"})})}),e.jsx(r,{children:e.jsx("strong",{children:"Dates"})}),e.jsx(r,{children:e.jsx(R,{active:d==="complimentary_nights",direction:d==="complimentary_nights"?C:"asc",onClick:()=>W("complimentary_nights"),children:e.jsx("strong",{children:"Comp. Nights"})})}),e.jsx(r,{children:e.jsx("strong",{children:"Reason"})}),e.jsx(r,{children:e.jsx(R,{active:d==="status",direction:d==="status"?C:"asc",onClick:()=>W("status"),children:e.jsx("strong",{children:"Status"})})}),e.jsx(r,{children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(xe,{children:ce.length===0?e.jsx(F,{children:e.jsx(r,{colSpan:8,align:"center",children:e.jsx(s,{color:"text.secondary",py:4,children:"No complimentary bookings found"})})}):ce.map(t=>e.jsxs(F,{hover:!0,children:[e.jsx(r,{children:t.booking_number}),e.jsxs(r,{children:[e.jsx(s,{variant:"body2",children:t.guest_name}),e.jsx(s,{variant:"caption",color:"text.secondary",children:t.guest_email})]}),e.jsxs(r,{children:[e.jsx(s,{variant:"body2",children:t.room_number}),e.jsx(s,{variant:"caption",color:"text.secondary",children:t.room_type})]}),e.jsxs(r,{children:[e.jsxs(s,{variant:"body2",children:[new Date(t.check_in_date).toLocaleDateString()," -"," ",new Date(t.check_out_date).toLocaleDateString()]}),t.complimentary_start_date&&t.complimentary_end_date&&e.jsxs(s,{variant:"caption",color:"success.main",children:["Comp: ",new Date(t.complimentary_start_date).toLocaleDateString()," -"," ",new Date(t.complimentary_end_date).toLocaleDateString()]})]}),e.jsx(r,{children:e.jsx(K,{label:`${t.complimentary_nights||0} nights`,size:"small",color:"success"})}),e.jsx(r,{children:e.jsx(G,{title:t.complimentary_reason||"No reason provided",children:e.jsx(s,{variant:"body2",sx:{maxWidth:150,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.complimentary_reason||"-"})})}),e.jsx(r,{children:e.jsx(K,{label:$e(t.status),size:"small",color:ze(t.status)})}),e.jsx(r,{children:e.jsxs(o,{sx:{display:"flex",gap:.5},children:[e.jsx(G,{title:"Edit complimentary details",children:e.jsx(V,{size:"small",color:"primary",onClick:()=>Be(t),children:e.jsx(pe,{fontSize:"small"})})}),e.jsx(G,{title:"Remove complimentary status",children:e.jsx(V,{size:"small",color:"error",onClick:()=>Le(t),children:e.jsx(je,{fontSize:"small"})})})]})})]},t.id))})]})})]}),e.jsx(ye,{value:ee,index:1,children:e.jsxs(se,{sx:{p:2},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(s,{variant:"h6",children:"Guest Complimentary Credits by Room Type"}),e.jsx(p,{variant:"contained",startIcon:e.jsx(at,{}),onClick:We,color:"secondary",children:"Add Credits"})]}),!f||f.length===0?e.jsx(s,{color:"text.secondary",children:"No guests with complimentary credits"}):e.jsxs(he,{size:"small",children:[e.jsx(ue,{children:e.jsxs(F,{children:[e.jsx(r,{children:e.jsx("strong",{children:"Guest"})}),e.jsx(r,{children:e.jsx("strong",{children:"Room Type"})}),e.jsx(r,{children:e.jsx("strong",{children:"Notes"})}),e.jsx(r,{align:"center",children:e.jsx("strong",{children:"Credits"})}),e.jsx(r,{align:"right",children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(xe,{children:(f||[]).map((t,a)=>e.jsxs(F,{children:[e.jsxs(r,{children:[e.jsx(s,{variant:"body2",children:t.guest_name}),e.jsx(s,{variant:"caption",color:"text.secondary",children:t.email})]}),e.jsx(r,{children:e.jsx(K,{label:t.room_type_code||t.room_type_name,size:"small",variant:"outlined"})}),e.jsx(r,{children:e.jsx(s,{variant:"caption",color:"text.secondary",children:t.notes||"-"})}),e.jsx(r,{align:"center",children:e.jsx(K,{label:`${t.nights_available} nights`,size:"small",color:"success"})}),e.jsx(r,{align:"right",children:e.jsxs(o,{sx:{display:"flex",gap:.5,justifyContent:"flex-end"},children:[e.jsx(G,{title:"Edit credits",children:e.jsx(V,{size:"small",color:"primary",onClick:()=>Ge(t),children:e.jsx(pe,{fontSize:"small"})})}),e.jsx(G,{title:"Delete credits",children:e.jsx(V,{size:"small",color:"error",onClick:()=>Fe(t),children:e.jsx(je,{fontSize:"small"})})})]})})]},`${t.guest_id}-${t.room_type_id}-${a}`))})]})]})}),e.jsxs(P,{open:be,onClose:()=>$(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(E,{children:"Edit Complimentary Booking"}),e.jsx(B,{children:i&&e.jsxs(o,{sx:{pt:1},children:[e.jsxs(w,{severity:"info",sx:{mb:2},children:["Booking: ",i.booking_number," - ",i.guest_name]}),e.jsxs(l,{container:!0,spacing:2,children:[e.jsx(l,{item:!0,xs:6,children:e.jsx(v,{fullWidth:!0,label:"Complimentary Start Date",type:"date",value:S.complimentary_start_date,onChange:t=>U({...S,complimentary_start_date:t.target.value}),InputLabelProps:{shrink:!0},inputProps:{min:i.check_in_date,max:i.check_out_date}})}),e.jsx(l,{item:!0,xs:6,children:e.jsx(v,{fullWidth:!0,label:"Complimentary End Date",type:"date",value:S.complimentary_end_date,onChange:t=>U({...S,complimentary_end_date:t.target.value}),InputLabelProps:{shrink:!0},inputProps:{min:i.check_in_date,max:i.check_out_date}})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(v,{fullWidth:!0,label:"Reason",multiline:!0,rows:2,value:S.complimentary_reason,onChange:t=>U({...S,complimentary_reason:t.target.value})})})]})]})}),e.jsxs(L,{children:[e.jsx(p,{onClick:()=>$(!1),children:"Cancel"}),e.jsx(p,{onClick:Ne,variant:"contained",disabled:y,children:y?"Updating...":"Update"})]})]}),e.jsxs(P,{open:Se,onClose:()=>M(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(E,{children:"Remove Complimentary Status"}),e.jsxs(B,{children:[e.jsx(w,{severity:"warning",sx:{mb:2},children:"Are you sure you want to remove the complimentary status from this booking? The original amount will be restored."}),i&&e.jsxs(o,{children:[e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Booking:"})," ",i.booking_number]}),e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Guest:"})," ",i.guest_name]}),e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Complimentary Nights:"})," ",i.complimentary_nights]}),i.original_total_amount&&e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Original Amount:"})," ",N(parseFloat(i.original_total_amount))]})]})]}),e.jsxs(L,{children:[e.jsx(p,{onClick:()=>M(!1),children:"Cancel"}),e.jsx(p,{onClick:Oe,variant:"contained",color:"error",disabled:y,children:y?"Removing...":"Remove Complimentary"})]})]}),e.jsxs(P,{open:De,onClose:()=>H(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(E,{children:"Add Complimentary Credits"}),e.jsx(B,{children:e.jsx(o,{sx:{pt:1},children:e.jsxs(l,{container:!0,spacing:2,children:[e.jsx(l,{item:!0,xs:12,children:e.jsx(it,{options:oe,getOptionLabel:t=>`${t.full_name}${t.email?` (${t.email})`:""}`,value:oe.find(t=>t.id===c.guest_id)||null,onChange:(t,a)=>A({...c,guest_id:(a==null?void 0:a.id)||0}),renderInput:t=>e.jsx(v,{...t,label:"Select Guest *"})})}),e.jsx(l,{item:!0,xs:12,children:e.jsxs(Je,{fullWidth:!0,children:[e.jsx(Ke,{children:"Room Type *"}),e.jsx(Xe,{value:c.room_type_id||"",label:"Room Type *",onChange:t=>A({...c,room_type_id:Number(t.target.value)}),children:Te.map(t=>e.jsxs(Ze,{value:t.id,children:[t.name," ",t.code?`(${t.code})`:""]},t.id))})]})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(v,{fullWidth:!0,label:"Number of Nights *",type:"number",value:c.nights,onChange:t=>A({...c,nights:parseInt(t.target.value)||0}),inputProps:{min:1}})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(v,{fullWidth:!0,label:"Notes",multiline:!0,rows:2,value:c.notes,onChange:t=>A({...c,notes:t.target.value}),placeholder:"e.g., Loyalty reward, Compensation, etc."})})]})})}),e.jsxs(L,{children:[e.jsx(p,{onClick:()=>H(!1),children:"Cancel"}),e.jsx(p,{onClick:Re,variant:"contained",color:"secondary",disabled:y,children:y?"Adding...":"Add Credits"})]})]}),e.jsxs(P,{open:ke,onClose:()=>q(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(E,{children:"Edit Complimentary Credits"}),e.jsx(B,{children:h&&e.jsxs(o,{sx:{pt:1},children:[e.jsxs(w,{severity:"info",sx:{mb:2},children:[e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Guest:"})," ",h.guest_name]}),e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Room Type:"})," ",h.room_type_name]})]}),e.jsxs(l,{container:!0,spacing:2,children:[e.jsx(l,{item:!0,xs:12,children:e.jsx(v,{fullWidth:!0,label:"Nights Available *",type:"number",value:k.nights_available,onChange:t=>te({...k,nights_available:parseInt(t.target.value)||0}),inputProps:{min:0}})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(v,{fullWidth:!0,label:"Notes",multiline:!0,rows:2,value:k.notes,onChange:t=>te({...k,notes:t.target.value})})})]})]})}),e.jsxs(L,{children:[e.jsx(p,{onClick:()=>q(!1),children:"Cancel"}),e.jsx(p,{onClick:Pe,variant:"contained",disabled:y,children:y?"Updating...":"Update Credits"})]})]}),e.jsxs(P,{open:we,onClose:()=>Q(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(E,{children:"Delete Complimentary Credits"}),e.jsxs(B,{children:[e.jsx(w,{severity:"warning",sx:{mb:2},children:"Are you sure you want to delete these complimentary credits? This action cannot be undone."}),h&&e.jsxs(o,{children:[e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Guest:"})," ",h.guest_name]}),e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Room Type:"})," ",h.room_type_name]}),e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Nights to Delete:"})," ",h.nights_available]})]})]}),e.jsxs(L,{children:[e.jsx(p,{onClick:()=>Q(!1),children:"Cancel"}),e.jsx(p,{onClick:Ee,variant:"contained",color:"error",disabled:y,children:y?"Deleting...":"Delete Credits"})]})]}),e.jsx(lt,{open:T.open,autoHideDuration:6e3,onClose:()=>m({...T,open:!1}),children:e.jsx(w,{severity:T.severity,onClose:()=>m({...T,open:!1}),children:T.message})})]})}export{Dt as default};
